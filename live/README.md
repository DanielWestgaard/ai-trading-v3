# Live Trading Pipeline

## Overview

The `live` directory contains the components necessary for executing live trading with machine learning models. This system connects to broker APIs, processes real-time market data, generates trading signals based on ML model predictions, and executes trades automatically.

## System Architecture

The live trading system consists of the following key components:

```
live/
├── broker_adapters/       # Adapters for different brokers (e.g., Capital.com)
├── execution_service/     # Services for executing trades
│   └── live_trading_service.py
├── live_data_handling/    # Real-time data processing
│   └── live_data_handler.py
├── live_trading_runner.py # Main entry point for running the system
├── monitors/              # Monitoring and alerting components
│   └── run_live_integration.py
└── temp_live/             # Temporary storage for live data
```

## Component Descriptions

### 1. Broker Adapters - to be implemented

Broker adapters provide a standardized interface to connect with different trading platforms. Currently, the system supports:

- **Capital.com**: Connects to Capital.com's REST and WebSocket APIs for market data and trade execution

Each adapter handles:
- Authentication and session management
- Market data subscription
- Order placement, modification, and cancellation
- Position management

### 2. Live Data Handling

The `LiveDataHandler` class is responsible for processing real-time market data:

- **Data Reception**: Processes incoming market data from WebSocket connections
- **Data Preprocessing**: Converts bid/ask pairs into **midpoint** prices, as a temporary solution
- **Feature Generation**: Calculates technical indicators and prepares data for model prediction
- **Data Storage**: Maintains an in-memory buffer of recent data and periodically saves to disk

### 3. Execution Service

The `LiveTradingService` acts as the central coordinator:

- Maintains the main trading loop
- Connects the model-based strategy to the broker
- Processes signals generated by the strategy
- Executes trades through the broker
- Manages the trading state and open positions
- Integrates with risk management

### 4. Live Trading Runner

The `live_trading_runner.py` file serves as the main entry point for the system:

- Loads configuration from YAML files
- Initializes all system components
- Sets up connections to the broker
- Warms up the system with historical data (currently the 250 newest values)
- Subscribes to real-time market data
- Handles graceful shutdown on interruption

## Data Flow

1. **Market Data Reception**:
   - Broker adapter subscribes to WebSocket feeds
   - Raw market data is processed by the LiveDataHandler

2. **Data Processing Pipeline**:
   ```
   Raw Market Data → Data Cleaning → Feature Generation → Model Input Preparation
   ```

3. **Decision Making**:
   - TimeframeResampler determines when trading decisions should be made
   - Strategy generates its own features from raw OHLC data
   - ML model makes predictions
   - SignalFilter evaluates prediction consensus
   - Trading signals are generated based on model predictions

4. **Trade Execution**:
   - RiskManager calculates position size and risk parameters (currently far too simple)
   - LiveTradingService executes trades through the broker
   - Portfolio is updated with new positions (could make a more enhanced for live trading to show from actual account)

## Configuration

The system is configured using YAML files:

```yaml
# live_trading_config.yaml
symbols: ['GBPUSD']
timeframe: 'MINUTE'
account_name: 'USD_testing'
initial_capital: 10000.0
max_active_positions: 1

model_type: 'xgboost'

strategy:
  prediction_threshold: 0.3
  confidence_threshold: 0.0
  lookback_window: 5
  consensus_threshold: 0.4
  min_hold_bars: 12
  max_hold_bars: 288
  decision_timeframe: 1

risk:
  position_sizing_method: 'percent'
  position_sizing_params:
    percent: 15.0
  # Additional risk parameters...
```
- Currently using the configuration located at "config/live_trading_config.yaml"

## How to Run

To run the live trading system:
```bash
main.py --live-integration
```
or
```bash
python live/live_trading_runner.py --config config/live_trading_config.yaml --model model_registry/model_storage/xgboost_20250403_102300.pkl
```

## Key Design Features

1. **Self-contained Strategy**: The strategy generates its own features from raw OHLC data
2. **Decoupled Components**: Each component is responsible for a specific function
3. **Risk Management**: Comprehensive risk controls including position sizing, stop-loss, and take-profit
4. **Monitoring**: Real-time performance monitoring and logging
5. **Error Handling**: Robust error handling and recovery mechanisms

## Dependencies

The live trading system relies on the shared components in the `core` directory, including:
- Events and signal processing
- Portfolio management
- Risk management
- Strategy implementations
- Performance tracking
- Timeframe resampler (decides when, periodically, we make executions based on predictions)